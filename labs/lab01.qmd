---
title: "Lab 1 – Δεσμευμένη Πιθανότητα, Κανόνας του Bayes & PPV/NPV"
author: "Πολυχρόνης Κωστούλας"
format:
  html:
    toc: true
    toc-depth: 3
    code-fold: show
    code-tools: true
    theme: cosmo
execute:
  warning: false
  message: false
---

## 1. Στόχοι Εργαστηρίου
Με την ολοκλήρωση αυτού του εργαστηρίου, θα είστε σε θέση να:

* εξηγείτε τι είναι **δεσμευμένη πιθανότητα** (conditional probability)
* εφαρμόζετε τον **Κανόνα του Bayes** κυρίως σε διαγνωστικά τεστ
* διακρίνετε **Ευαισθησία/Ειδικότητα** από **PPV/NPV**
* κατανοείτε πώς ο **επιπολασμός (pre-test probability / prevalence)** επηρεάζει την αξιοπιστία ενός θετικού/αρνητικού αποτελέσματος

---

## 2. Προετοιμασία: Πακέτα και Ρυθμίσεις

```{r setup}
#| label: setup
options(timeout = 600)

pkgs <- c("dplyr", "ggplot2", "tidyr", "tibble", "scales")

to_install <- setdiff(pkgs, rownames(installed.packages()))
if (length(to_install) > 0) {
  install.packages(to_install, repos = "https://cloud.r-project.org")
}

suppressPackageStartupMessages(
  invisible(lapply(pkgs, library, character.only = TRUE))
)

theme_set(theme_minimal(base_size = 14))
```
---

## 3. Δεσμευμένη πιθανότητα (Conditional probability)

Στη διάγνωση μάς ενδιαφέρουν πιθανότητες υπό συνθήκη.

	•	(D): “το άτομο έχει τη νόσο”
	•	(\bar D): “το άτομο δεν έχει τη νόσο”
	•	(T^+): “το τεστ είναι θετικό”
	•	(T^-): “το τεστ είναι αρνητικό”

Δεσμευμένη πιθανότητα:
[
P(D \mid T^+) = \frac{P(D \cap T^+)}{P(T^+)}
]

Δηλαδή: “πιθανότητα νόσου δεδομένου ότι το τεστ βγήκε θετικό”.

---

## 4. Παράμετροι τεστ: Se/Sp και τι σημαίνουν

Δείκτες της αξιοπιστίας μιας διαγνωστικής δοκιμής είναι:

	•	Η Ευαισθησία (Sensitivity, Se):
[
Se = P(T^+ \mid D)
]
	•	Η Ειδικότητα (Specificity, Sp):
[
Sp = P(T^- \mid \bar D)
]

Αυτές είναι πιθανότητες προϋποθέτουν τη γνώση της κατάστασης νόσου. Όμως στην πράξη συχνά ρωτάμε το αντίστροφο:

	•	PPV: (P(D \mid T^+))
	•	NPV: (P(\bar D \mid T^-))

Δηλαδή, στην κλινική πράξη, κάνουμε το τεστ για να δούμε αν το άτομο νοσεί ή όχι. 

---

## 5. Κανόνας του Bayes

Ο Κανόνας του Bayes συνδέει τα παραπάνω:

[
P(D \mid T^+) = \frac{P(T^+ \mid D),P(D)}{P(T^+)}
]

Όπου:

	•	(P(D)) είναι η pre-test probability (σε πληθυσμιακό επίπεδο: ο επιπολασμός)
	•	(P(T^+ \mid D)) είναι η ευαισθησία
	•	(P(T^+)) είναι η συνολική πιθανότητα να βγει θετικό το τεστ:

[
P(T^+) = P(T^+ \mid D)P(D) + P(T^+ \mid \bar D)P(\bar D)
]
και (P(T^+ \mid \bar D)=1-Sp).

---

## 6. Από τον Bayes σε PPV και NPV (τύποι)


6.1 PPV

[
PPV = P(D \mid T^+) = \frac{Se \cdot Prev}{Se \cdot Prev + (1-Sp)\cdot(1-Prev)}
]

6.2 NPV

[
NPV = P(\bar D \mid T^-) = \frac{Sp \cdot (1-Prev)}{Sp \cdot (1-Prev) + (1-Se)\cdot Prev}
]


::: {.callout-tip}
🎥 [Bίντεο επεξήγησης:](https://youtu.be/hLiL24vL3rg)
:::

---

## 7. Υπολογισμοί στην R (καθαρά και επαναχρησιμοποιήσιμα)

Θα φτιάξουμε μία μικρή συνάρτηση ώστε να υπολογίζουμε PPV/NPV χωρίς να ξαναγράφουμε τύπους.

#| label: functions

check_probs <- function(prev, se, sp) {
  ok <- all(prev >= 0, prev <= 1, se >= 0, se <= 1, sp >= 0, sp <= 1)
  if (!ok) stop("Όλες οι πιθανότητες πρέπει να είναι στο [0,1].")
}

ppv_npv <- function(prev, se, sp) {
  check_probs(prev, se, sp)
  ppv <- (se * prev) / ((se * prev) + ((1 - sp) * (1 - prev)))
  npv <- (sp * (1 - prev)) / ((sp * (1 - prev)) + ((1 - se) * prev))
  tibble(prev = prev, se = se, sp = sp, ppv = ppv, npv = npv)
}


---

8. Παράδειγμα: σπάνια νόσος

Έστω:
	•	Επιπολασμός (Prev) = 1%
	•	Ευαισθησία (Se) = 95%
	•	Ειδικότητα (Sp) = 90%

#| label: example-calc

prevalence  <- 0.01
sensitivity <- 0.95
specificity <- 0.90

res <- ppv_npv(prevalence, sensitivity, specificity)

res %>%
  mutate(
    prev = scales::percent(prev),
    ppv  = scales::percent(ppv, accuracy = 0.01),
    npv  = scales::percent(npv, accuracy = 0.01)
  )

::: {.callout-note}
Ερμηνεία:
Σε σπάνια νόσο, ακόμη και “καλό” τεστ μπορεί να έχει χαμηλή PPV (πολλοί ψευδώς θετικοί από το μεγάλο ποσοστό υγιών).
Αντίθετα, η NPV συχνά είναι πολύ υψηλή, γιατί οι περισσότεροι είναι όντως υγιείς.
:::

---

## 9. Προσομοίωση: πώς αλλάζουν PPV/NPV όταν αλλάζει ο επιπολασμός

Θα κρατήσουμε Se/Sp σταθερά και θα δούμε τι γίνεται όταν το τεστ μπαίνει σε διαφορετικούς πληθυσμούς (χαμηλού/υψηλού κινδύνου).

#| label: simulation-data

sim_data <- tibble(
  prev = seq(0.001, 0.5, length.out = 200),
  se = 0.95,
  sp = 0.90
) %>%
  mutate(
    ppv = (se * prev) / ((se * prev) + (1 - sp) * (1 - prev)),
    npv = (sp * (1 - prev)) / ((sp * (1 - prev)) + (1 - se) * prev)
  )

### 9.1 Γράφημα: Επιπολασμός vs PPV

#| label: plot-ppv
#| fig-cap: "Σχέση Επιπολασμού και PPV (Se=95%, Sp=90%)"

ggplot(sim_data, aes(x = prev, y = ppv)) +
  geom_line(size = 1.1) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Πώς ο επιπολασμός καθορίζει την PPV",
    x = "Επιπολασμός (Pre-test probability / Prior)",
    y = "PPV = P(D | T+)"
  )

### 9.2 Γράφημα: Επιπολασμός vs NPV

#| label: plot-npv
#| fig-cap: "Σχέση Επιπολασμού και NPV (Se=95%, Sp=90%)"

ggplot(sim_data, aes(x = prev, y = npv)) +
  geom_line(size = 1.1) +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(labels = scales::percent) +
  labs(
    title = "Πώς ο επιπολασμός καθορίζει την NPV",
    x = "Επιπολασμός (Pre-test probability / Prior)",
    y = "NPV = P(¬D | T-)"
  )


---

## 10. Ασκήσεις Εργαστηρίου

Άσκηση 1 — Η δύναμη της ειδικότητας σε σπάνια νόσο

### Στο σενάριο Prev=1%, Se=95%:
	1.	Αλλάξτε την ειδικότητα από 90% σε 99% και υπολογίστε το νέο PPV και NPV.
	2.	Εξηγήστε με 2–3 προτάσεις γιατί η ειδικότητα “μετράει” τόσο πολύ όταν η νόσος είναι σπάνια.

#| label: exercise-1
ppv_npv(prev = 0.01, se = 0.95, sp = 0.99)

### Άσκηση 2 — Ομάδα χαμηλού vs υψηλού κινδύνου

Ένα τεστ με Se=90% και Sp=90% εφαρμόζεται σε δύο πληθυσμούς:
	•	Α: Prev = 0.5%
	•	Β: Prev = 15%

Υπολογίστε PPV και NPV και για τους δύο.

#| label: exercise-2
bind_rows(
  ppv_npv(prev = 0.005, se = 0.90, sp = 0.90) %>% mutate(group = "A (Prev 0.5%)"),
  ppv_npv(prev = 0.15,  se = 0.90, sp = 0.90) %>% mutate(group = "B (Prev 15%)")
) %>%
  select(group, prev, se, sp, ppv, npv) %>%
  mutate(across(c(prev, se, sp, ppv, npv), ~scales::percent(.x, accuracy = 0.01)))


---

## 11. Σύνοψη

	•	Η δεσμευμένη πιθανότητα είναι το “κλειδί” για το τι μας ενδιαφέρει στη διάγνωση.
	•	Ο Κανόνας του Bayes συνδυάζει:
	•	αυτό που ξέραμε πριν (pre-test probability / prior)
	•	με την πληροφορία του τεστ (Se/Sp)
	•	Οι PPV/NPV αλλάζουν δραματικά με τον επιπολασμό.

👉 Επόμενο εργαστήριο: Θα δούμε πώς περνάμε από “μία τιμή” prior σε κατανομή prior (π.χ. Beta), ώστε να εκφράζουμε αβεβαιότητα.

